# LCAcollect API Gateway

This service uses the Rust based [Apollo Router](https://www.apollographql.com/docs/router/).

It will use the rover CLI for building the supergraph.

# Folder Structure
```
config/
    # Contains config files
helm/
    # helm chart for deployment
    # source code
    build_graph.sh
        # script for building supergraph in container
    build_graph_local.sh
        # script for building supergraph locally - NOTE: that rover is required
    Dockerfile
        # Rover dockerfile
    skaffold.yaml
        # Skaffold setup for running Rover & Router containers independently
```

# Config Files

## Container Setup

The supergraph is generated within the initContainer.
The Dockerfile and Skaffold takes care of including the right `.graphql` files and copying them into the container. 
The `supergraph-config.yaml`'s paths is therefore scoped to the container and not the git repo.

## SuperGraph Config
The supergraph config looks like this:

```yaml
# supergraph-config.yaml

federation_version: 2
subgraphs:
  projects:
    routing_url: "http://foo.bar/projects"
    schema:
      file: ../modules/projects/schema.graphql
```

The routing_url is FUBAR for the graph as it can now be overwritten by runtime environment variables.

The supergraph is generated by rover - see commands below.

## Router Config

The router configuration looks like this:

```yaml
# router.yaml

server:
  endpoint: /graphql
  landing_page: false # disable the playground for the gateway
  cors:
    origins: # Specific Origin required with allow credentials set to true.
      - ${CLIENT_ORIGIN:http://localhost:3000}
    allow_credentials: true
headers:
  all: # Header rules for all subgraphs
    - propagate: # send the following matching headers onwards from the client to all subgraphs
        matching: ^Auth.*

override_subgraph_url:
  projects: ${PROJECT_URL:http://localhost:5000}
```

This runtime supports reading environment variables and replacing them for the config file.

# Get Started

**Make sure Minikube is running**
```shell
minikube start
```

**Start dev server**
```shell
skaffold dev
```

**Build local Rover Docker image**
```shell
cd ../ && docker build -t rover -f router/Dockerfile .
```

**Run Rover locally**
```shell
rover supergraph compose --config ./config/supergraph-config-local.yaml > config/supergraph.graphql
```

**Run Router locally**
```shell
./router --config config/router.yaml --supergraph config/supergraph.graphql
```

# Local Dependencies

**Router**
```shell
curl -sSL https://router.apollo.dev/download/nix/latest | sh
```

**Rover**
```shell
curl -sSL https://rover.apollo.dev/nix/latest | sh
```